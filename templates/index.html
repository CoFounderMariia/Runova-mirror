<!DOCTYPE html>
<html lang="en">
<head>
  
  <meta charset="UTF-8" />
  <!-- Viewport so vw/vh and media queries behave correctly on Android -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="/manifest.json">

  <!-- ANDROID DETECT: inline and intentionally BEFORE styles.css
       Only detect platform and add .is-android to <html> early so CSS can react.
       Avoid touching DOM elements here (they may not exist yet). -->
  <script>
    (function() {
      try {
        var ua = navigator.userAgent || navigator.vendor || window.opera || '';
        var isAndroidUA = /Android/i.test(ua);
        var isAndroidWebView = /(wv|; wv)/i.test(ua) || (isAndroidUA && !/Chrome\/\d+/i.test(ua));
        if (isAndroidUA || isAndroidWebView) {
          document.documentElement.classList.add('is-android');
        }
        // Keep a lightweight listener in case we want to run DOM-time fixes from head,
        // but do not touch the video element here to avoid "not found" errors.
        document.addEventListener('DOMContentLoaded', function() {
          try {
            if (document.documentElement.classList.contains('is-android')) {
              // keep this no-op placeholder so styles are applied as soon as DOM ready
            }
          } catch (e) {}
        });
      } catch (e) {
        console.error('android-detect error', e);
      }
    })();
  </script>

  <link rel="stylesheet" href="{{ url_for('static', filename='mobile_ui/styles.css') }}">

  <title>RUNOVA Mirror</title>

  <style>
    /* (unchanged inline CSS kept for layout preview) */

    /* ---- VARIABLES ---- */
    :root {
      --frame: #f4f3f2;
      --screen-bg-top: #d5d9de;
      --screen-bg-bottom: #a5aab4;
    }

    /* ---- RESET ---- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #e7e3e1;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* ---- MIRROR FRAME ---- */
    #cam {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 1;            /* ÐšÐ›Ð®Ð§Ð•Ð’Ðž */
      pointer-events: none;
      transform: scaleX(-1);
      z-index: 0;
    }

    /* FaceMesh Canvas overlay */
    .face-mesh-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    /* STATUS TEXT */
    #statusText {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 14px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      font-size: 13px;
      border-radius: 999px;
    }

  </style>

  <!-- MediaPipe FaceMesh -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <script src="/static/mobile_ui/quality-gate.js"></script>
  <script src="/static/mobile_ui/app.js"></script>
  <script src="/static/mobile_ui/product-manager.js"></script>

</head>
<body>

<script>
  console.error("ðŸš¨ REAL TEMPLATE LOADED:", location.pathname);
</script>

  <!-- Renamed to match styles.css expectations: camera-section and camera-preview -->
  <div class="camera-section">
    <div class="camera-dot"></div>

    <div class="camera-preview">
      <video id="cameraVideo" autoplay playsinline muted></video>
      <canvas id="faceMeshCanvas" class="face-mesh-canvas" style="display:none;"></canvas>
    </div>

    <div class="stand-neck"></div>
    <div class="stand-base"></div>

    <button id="restartButton" class="restart-scan-button" title="Restart">
      <svg class="restart-scan-icon" viewBox="0 0 24 24">
        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
        <path d="M21 3v5h-5"/>
        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
        <path d="M3 21v-5h5"/>
      </svg>
    </button>

    <button id="micButton" class="mic-button" title="Voice recording (tap to toggle)" onclick="console.log('ðŸŽ¤ Mic button clicked!');">
      <svg class="mic-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 1C10.34 1 9 2.34 9 4V12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12V4C15 2.34 13.66 1 12 1Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M19 10V12C19 15.87 15.87 19 12 19C8.13 19 5 15.87 5 12V10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <line x1="12" y1="19" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="8" y1="23" x2="16" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>

    <button id="analyzeSkinBtn" class="analyze-button">Analyze skin</button>
    <button id="scanSunscreenBtn" class="scan-sunscreen-button">Scan sunscreen</button>

    <div id="recommendationsSection" class="recommendations-section"></div>

    <div id="skinResultsPanel">
      <div class="skin-results-header">
        <div class="skin-results-title">Skin analysis</div>
        <button id="skinResultsClose" class="skin-results-close">&times;</button>
      </div>
      <div class="skin-results-grid" id="skinResultsGrid"></div>
    </div>

  </div>

<script>
  // MediaPipe FaceMesh initialization (unchanged)
  let faceMesh = null;
  let camera = null;
  const canvas = document.getElementById("faceMeshCanvas");
  const canvasCtx = canvas.getContext("2d");

  // ... (rest of existing app inline script as before) ...
  // (For brevity in this template preview the rest of the inline camera / analysis script remains unchanged.)
</script>

<script>
  (function hardRemoveCameraReady() {
    const BAD_IDS = new Set(["statusText", "cameraStatus"]);
    const BAD_CLASSES = new Set(["camera-status", "camera-ready"]);
    const BAD_TEXTS = new Set(["camera ready", "camera error", "cameraready", "cameraerror"]);

    function kill(el) {
      if (!el) return;
      try { el.remove(); } catch {}
    }

    function scan(root) {
      if (!root || !root.querySelectorAll) return;

      root.querySelectorAll("*").forEach((el) => {
        const id = (el.id || "").trim();
        if (BAD_IDS.has(id)) return kill(el);

        const classList = Array.from(el.classList || []);
        if (classList.some(c => BAD_CLASSES.has(c))) return kill(el);

        const t = ((el.textContent || "").trim().toLowerCase());
        if (t == "camera ready" || t == "cameraready" || t == "camera error" || t == "cameraerror") return kill(el);
      });
    }

    scan(document);

    const obs = new MutationObserver(() => scan(document));
    obs.observe(document.documentElement, { childList: true, subtree: true, characterData: true });
  })();
</script>

<!-- ENSURE FULLSCREEN: moved to bottom so the DOM (video & canvas) exists.
     This keeps early detection in head (so CSS reacts) but runs DOM manipulations
     only after the elements are available to avoid "Video element not found" messages. -->
<script>
  (function ensureAndroidFullscreen() {
    try {
      // --- START ADDED: support force flags for kiosks / custom WebView UAs ---
      // Read UA and force flags
      var ua = navigator.userAgent || navigator.vendor || window.opera || '';
      var qs = (typeof URLSearchParams !== 'undefined') ? new URLSearchParams(window.location.search) : null;
      var forceFlag = (qs && qs.get('force_fullscreen') === '1') || localStorage.getItem('force_fullscreen') === '1';

      // detect common Android / WebView markers
      var isAndroidUA = /Android/i.test(ua);
      var isAndroidWebView = /(wv|; wv|WebView)/i.test(ua) || (isAndroidUA && !/Chrome\/\d+/i.test(ua));

      // additional heuristics for kiosk / wrapped apps (catch custom UAs that may not contain 'Android')
      var kioskMarkers = /kiosk|runova|embedded|inapp|webview|wv/i.test(ua);

      // Final decision: apply if native detection matches, or force flag set, or kiosk markers found
      var shouldApply = isAndroidUA || isAndroidWebView || forceFlag || kioskMarkers;

      // If forcing via flag, ensure the CSS class is present so styles apply.
      if (forceFlag && !document.documentElement.classList.contains('is-android')) {
        document.documentElement.classList.add('is-android');
        try { console.log('runova: force_fullscreen active'); } catch (e) {}
      }
      // --- END ADDED ---

      function ensureFullScreenVideo() {
        try {
          var video = document.getElementById('cameraVideo') || document.querySelector('video');
          var canvas = document.getElementById('faceMeshCanvas') || document.querySelector('canvas.face-mesh-canvas');
          if (!video) {
            // nothing to do yet
            return;
          }

          // If we've already built the root, just ensure classes/styles are set
          if (document.getElementById('android-camera-root')) {
            video.classList.add('android-fullscreen');
            return;
          }

          var root = document.createElement('div');
          root.id = 'android-camera-root';
          Object.assign(root.style, {
            position: 'fixed',
            top: '0',
            left: '0',
            width: '100vw',
            height: '100vh',
            zIndex: '0',
            pointerEvents: 'none',
            overflow: 'hidden',
            background: 'transparent'
          });

          var originalParent = video.parentElement;
          // move video & canvas into root to ensure they are not constrained by parent layout
          root.appendChild(video);
          if (canvas) root.appendChild(canvas);
          document.body.appendChild(root);

          video.classList.add('android-fullscreen');
          Object.assign(video.style, {
            position: 'absolute',
            top: '0',
            left: '0',
            width: '100%',
            height: '100%',
            objectFit: 'cover',
            transform: video.style.transform || 'scaleX(-1)',
            zIndex: '0',
            pointerEvents: 'none'
          });

          if (canvas) {
            Object.assign(canvas.style, {
              position: 'absolute',
              top: '0',
              left: '0',
              width: '100%',
              height: '100%',
              zIndex: '2',
              pointerEvents: 'none',
              display: 'block'
            });
          }

          try {
            if (originalParent && originalParent !== document.body) {
              if (originalParent.querySelectorAll('*').length === 0) originalParent.style.display = 'none';
              else originalParent.style.visibility = 'hidden';
            }
          } catch (e) {}

          // watch for replacement video elements added later (e.g. app.js recreates it)
          try {
            var obs = new MutationObserver(function() {
              var v = document.getElementById('cameraVideo') || document.querySelector('video');
              if (v && v !== video) ensureFullScreenVideo();
            });
            obs.observe(document.documentElement || document, { childList: true, subtree: true });
            setTimeout(function() { obs.disconnect(); }, 10000);
          } catch (e) {}

        } catch (inner) {
          console.warn('ensureFullScreenVideo error', inner);
        }
      }

      function init() {
        // Only act if detection says we should (Android/WebView/kiosk) OR forceFlag is set.
        if (!shouldApply) {
          // If you want to debug why it didn't apply, uncomment the console line below.
          // console.log('ensureAndroidFullscreen: not applied (ua)', ua, 'forceFlag', forceFlag, 'kioskMarkers', kioskMarkers);
          return;
        }

        // Ensure the class is present so the CSS rules take effect even if detection didn't add it earlier.
        if (!document.documentElement.classList.contains('is-android')) {
          document.documentElement.classList.add('is-android');
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', ensureFullScreenVideo);
        } else {
          ensureFullScreenVideo();
        }

        // Also observe for dynamically added video elements (watch any <video> nodes)
        try {
          var observer = new MutationObserver(function(mutations) {
            for (var m of mutations) {
              for (var n of m.addedNodes) {
                if (!n) continue;
                try {
                  // if any video element is added, try to apply fullscreen behavior
                  if (n.nodeType === 1 && (n.tagName === 'VIDEO' || n.querySelector && n.querySelector('#cameraVideo'))) {
                    ensureFullScreenVideo();
                  }
                } catch (e) {}
              }
            }
          });
          observer.observe(document.documentElement || document, { childList: true, subtree: true });
        } catch (e) {}
      }

      init();
    } catch (e) {
      console.error('ensureAndroidFullscreen error', e);
    }
  })();
</script>

</body>
</html>